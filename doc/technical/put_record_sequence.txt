User -> RecordController: PUT /record/pid1,pid2,...

activate RecordController
note left of RecordController: Executing Fetch User Sequence returns u

alt u == null || !u.hasPermission("record:modify") 
RecordController --> User: 403: Forbidden
end 

alt !u.hasPermission("record:permissions") && Provided 'record:permissions' fields
    RecordController --> User: 403: Forbidden
end

loop for each pid in url
    note right of User
    On any DB error:
    Rollback and 
    return 500: Internal Server Error
    end note

note left of RecordController: Executing Fetch Record Sequence returns r
    
alt r == null
    

    RecordController -> RecordController: r = new Record()
RecordController -> RecordLookupService: getName(pid)
    deactivate RecordController
    

    activate RecordLookupService
    note left of RecordLookupService: api.iisg.nl
    RecordLookupService --> RecordController: name : String
    deactivate RecordLookupService

    activate RecordController
    note left of RecordController: Set record fields
    RecordController -> RecordService: add(r)
    deactivate RecordController

    activate RecordService
    RecordService --> RecordController: 
    deactivate RecordService

else otherwise
    
    activate RecordController
    note left of RecordController: Modify record/contact fields
    RecordController -> RecordService: save(r)
    deactivate RecordController
    
    activate RecordService
    RecordService --> RecordController:
    deactivate RecordService
      
end

opt 
    activate RecordController
    note left of RecordController: Set contact and location information
    RecordController -> RecordService: addContact/saveContact(r,contact)
    deactivate RecordController

    activate RecordService
    RecordService -> ContactDAO: add/save(contact)
    deactivate RecordService

    activate ContactDAO
    ContactDAO --> RecordService: 
    deactivate ContactDAO

    activate RecordService
    RecordService --> RecordController: 
    deactivate RecordService

loop for each location
    activate RecordController
    RecordController -> RecordService: addLocation/saveLocation(r,location)
    deactivate RecordController

    activate RecordService
    RecordService -> LocationDAO: add/save(location)
    deactivate RecordService

    activate LocationDAO
    LocationDAO --> RecordService: 
    deactivate LocationDAO

    activate RecordService
    RecordService --> RecordController: 
    deactivate RecordService
end

end

end

activate RecordController
RecordController --> User: 200: Ok
deactivate RecordController
