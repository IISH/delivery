\documentclass[a4paper,titlepage]{report}
\usepackage{fullpage}
\usepackage{titlesec}
\usepackage{array}
\usepackage{url}
\usepackage{float}
\usepackage{listings}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{verbatim}
\usepackage[dutch]{babel}
\usepackage[toc,nonumberlist,style=altlist,translate=true]{glossaries}
\usepackage{glossaries-babel}
\makeglossaries

% Nummering voor subsubs en pars
\renewcommand{\thesubsubsection}{\arabic{subsubsection}}
\renewcommand{\theparagraph}{\thesubsubsection.\arabic{paragraph}}

\lstset{
    numbers=none,
    frame=shadowbox,
    identifierstyle=\ttfamily,
    keywordstyle=\color[rgb]{0,0,0},
    commentstyle=\color[rgb]{0,0,0},
    stringstyle=\color[rgb]{0,0,0},
    xleftmargin=30pt,
    xrightmargin=10pt,
    showstringspaces=false,
    breaklines=true,
    escapeinside={(*@}{@*)}
}

\makeatletter
% Label with name
\def\namedlabel#1#2{
  \label{#1}
  \begingroup
   \def\@currentlabel{#2}%
   \label{#1:name}\endgroup
}

% Reference with name
\def\namedref#1{\ref{#1} \ref{#1:name}}
\makeatother

\title{Delivery:\\ Architectural Design\\ Milestone 1\\ Iteratie 3\\ RC 5}
\author{Lucas de Vries \& Stefan van Wouw}
\begin{document}
\maketitle
\input{../glossary}

\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{2}

\tableofcontents
\pagebreak

\chapter{Inleiding}
Het Internationaal Instituut voor Sociale Geschiedenis (IISG) heeft circa 3000
archieven, 1 miljoen boeken en tijdschriften en een rijke collectie beeld- en
geluidsmateriaal in beheer. De \glspl{def:stuk} kunnen worden ingezien op de
studiezaal en er kunnen reproducties worden besteld. De processen die bij het
inzien en reproduceren van stukken komen kijken gaan op dit moment nog met de
hand. 

In het Requirements document zijn eisen opgesteld aan het IT-systeem dat deze
processen dient te stroomlijnen en automatiseren. Daarbij is door middel van
\glspl{def:use-case} aangegeven hoe de interactie tussen de gebruikers en het
systeem zal verlopen.

In dit document wordt de ontworpen systeem architectuur gepresenteerd. In
hoofdstuk \ref{cha:systeem_ontwerp} wordt het systeem ontwerp besproken.
Vervolgens wordt het database ontwerp beschreven in hoofdstuk \ref{cha:db} en
wordt de Application Programming Interface (\gls{def:api}) specificatie uiteengezet in
hoofdstuk \ref{cha:api}.

\chapter{Systeem Ontwerp}
Dit hoofdstuk beschrijft het systeem ontwerp. Als eerste wordt er een
decompositie in subsystemen gegeven in sectie \ref{sec:subsystem_decomp}. De
problemen die komen kijken bij het (vrijwel)
tegelijkertijd modificeren van data worden besproken in sectie
\ref{sec:concurrency}. Daarna worden de globale toegangsrechten besproken in
sectie \ref{sec:toegangsrechten}. Tot slot worden de start- en
herstelprocedures uiteengezet in sectie \ref{sec:startherstel}.


\label{cha:systeem_ontwerp}
  \section{Subsysteem Decompositie}
  \label{sec:subsystem_decomp}
  Voor de indeling van het systeem wordt een \gls{def:mvc} (Model-View-Controller)
  ontwerppatroon gebruikt. De benodigde data die in de database van het systeem
  staat (zie hoofdstuk \ref{cha:db}) wordt door middel van de model klassen
  opgevraagd. Er is een API waarmee zoeksystemen als \gls{def:vufind}
  \gls{def:uitleenstatus} e.d. kunnen opvragen. Ook is er een abstractielaag
  voor de APIs waarmee het systeem meer informatie over stukken kan opvragen. Zo
  wordt er bij elke \gls{def:reservering}\glsadd{def:aanvraag} een overzicht
  gegenereerd aan de hand van informatie verkregen uit \gls{def:oai}, en wordt
  de Shared Object Repository (\gls{def:sor}) gebruikt om periodiek te kijken of
  bepaalde analoge stukken al gedigitaliseerd zijn.

  \begin{figure}[H]
    \label{fig:decomposition}
    \centering
    \includegraphics[width=106mm]{decomposition.pdf}
    \caption{Globale decompositie in subsystemen}
  \end{figure}
    
  \section{Concurrency Problemen}
  \label{sec:concurrency}
  % Tegelijk reserveren van een stuk (repro/inzage)
  Er kunnen zich verscheidene problemen voordoen indien men bepaalde acties
  tegelijkertijd uitvoert. Hieronder een overzicht van de belangrijkste
  problemen en de genomen beslissingen om deze problemen op te
  lossen.
  
    \subsection{Tegelijkertijd hetzelfde stuk reserveren}
    \begin{description}
      \item[Probleem] Meerdere bezoekers zijn via het externe zoeksysteem op
        de reserveringspagina gekomen om hetzelfde stuk te reserveren (de
        status is op dat moment immers nog `beschikbaar'). Er kan slechts
        \'e\'en persoon tegelijk het stuk reserveren.
      \item[Oplossing] Het systeem dient op het moment dat de gebruiker de
        reserveringspagina betreedt en elke keer dat een gebruiker het
        reserveringsformulier submit te controleren of de te reserveren
        stukken nog beschikbaar zijn. Op het moment dat een stuk in de
        selectie van te reserveren items al gereserveerd blijkt te zijn,
        krijgt de bezoeker een bericht met daarin de keuze om door te gaan met
        reserveren voor de overige stukken in de selectie, of om de
        reservering af te breken.
    \end{description}
    
    \subsection{Reproduceren van een (continu) uitgeleend stuk}
    \label{subsec:repro_uitgeleend}
    \begin{description}
      \item[Probleem] Een bezoeker heeft een reproductie van een nog niet
        gedigitaliseerd stuk aangevraagd. De reproductiemedewerker ziet dat
        hij het stuk dient te digitaliseren, maar het stuk is (continu)
        uitgeleend voor inzage.
      \item[Oplossing] Om te voorkomen dat een stuk nooit gedigitaliseerd kan
        worden doordat het continu uitgeleend is voor inzage, wordt er door
        het systeem een speciale reproductie reservering aangemaakt voor een
        stuk, ook als deze al uitgeleend is voor inzage. Op het moment dat de
        bezoeker het stuk retourneert, checkt het systeem voordat het stuk de
        status `beschikbaar' krijgt of er een reproductie reservering bestaat.
        Indien dat het geval is wordt de reproductie reservering actief in
        plaats van dat het systeem het stuk weer vrij geeft voor inzage.
    \end{description}
    
  \section{Toegangsrechten}
  \label{sec:toegangsrechten}
  Bij het IISG zijn er twee groepen medewerkers die gebruik moeten gaan maken
  van het systeem: studiezaal- en reproductiemedewerkers.
  Elke groep medewerkers mag bepaalde acties binnen het systeem uitvoeren. Deze
  acties zijn gespecificeerd door middel van bepaalde rechten in de database,
  en kunnen indien gewenst uitgebreid worden. Elke medewerker krijgt een apart
  user account, gelinkt aan een bepaalde medewerker groep. Naast de reguliere
  medewerkers zijn er ook een aantal medewerkers met meer bevoegdheden. Deze
  medewerkers vallen onder de administratoren groep. 
  
  De bezoekers die gebruik maken van het systeem krijgen geen apart user
  account, en worden dus als \'e\'en homogene groep beschouwd, waar geen
  configureerbare permissies voor aanwezig zijn in de database.
 \clearpage 
  De volgende basisrechten voor medewerkers kunnen worden onderscheiden:
  
  \begin{center}
  \begin{tabular}{l p{8cm} l}
    \textbf{Recht} & \textbf{Uitleg} & \textbf{Groepen IISG} \\
      record:modify
      & Mag metadata over een stuk aanpassen.
      & Studiezaal
    \\

      record:delete
      & Mag metadata over een stuk verwijderen.
      & Administratoren
    \\

      record:contact:view
      & Mag contactinformatie van een stuk inzien (voorkomt het ongeauthoriseerd
      opvragen van contactinformatie via de API).
      & Allen
    \\

    reservation:view
      & Mag actieve en gearchiveerde reserveringen bekijken.
      & Allen
    \\

    reservation:modify
      & Mag de informatie bij een reservering aanpassen.
      & Studiezaal
    \\

    reservation:delete
      & Mag de informatie bij een reservering verwijderen.
      & Administratoren
    \\

    order:view
      & Mag actieve en gearchiveerde orders bekijken.
      & Reproductie
    \\

    order:modify
      & Mag de informatie bij een order aanpassen.
      & Reproductie
    \\

    order:delete
      & Mag de informatie bij een order verwijderen.
      & Administratoren
    \\

    permission:view
      & Mag actieve en gearchiveerde verzoeken voor toestemming bekijken.
      & Studiezaal
    \\

    permission:modify
      & Mag de informatie bij een verzoek aanpassen.
      & Studiezaal
    \\

    permission:delete
      & Mag de informatie bij een verzoek verwijderen.
      & Administratoren
    \\
  \end{tabular}
  \end{center}
  
  
  \section{Start- en Herstelprocedures}
  \label{sec:startherstel}  
  Het systeem komt in zijn geheel op een webserver te draaien en kan door
  middel van HTML formulieren of API calls worden aangesproken. Als het
  systeem uitvalt terwijl een gebruiker het systeem wil raadplegen krijgt de
  gebruiker geen verbinding met het systeem. Als de oorzaak van het probleem
  (verbinding/server uitgevallen) is opgelost kan de gebruiker weer verbinding
  maken met de server en is het systeem weer functioneel beschikbaar. Behalve
  het opnieuw opstarten van het systeem of het oplossen van
  verbindingsproblemen hoeven er geen speciale acties te worden ondernomen.\\
  
  Het systeem maakt gebruik van meerdere externe systemen (zie
  hoofdstuk \ref{cha:api}). Voor het uitvallen van deze systemen geldt dat
  indien dat gebeurt tijdens een use case (een bezoeker of
  medewerker is betrokken), er een gebruikersvriendelijke foutmelding dient te
  worden weergegeven. Als de informatie van het externe systeem essentieel is
  voor de voortzetting van de use case dient deze be\"eindigd te worden,
  anders dient er doorgegaan te worden met de use case.
    
  Voor het uitvallen van de externe systemen tijdens een periodieke update
  aanvraag van het systeem geldt dat het systeem het  na korte tijd opnieuw
  moet proberen en anders de ingestelde periodieke tijd moet wachten met
  opvragen.
    
   
  

\chapter{Database Ontwerp}
\label{cha:db}
In de onderstaande figuren is het database ontwerp te zien. Zoals besproken in
sectie \ref{sec:toegangsrechten} is te zien dat elke gebruiker in meerdere
groepen ingedeeld kan worden en dat elke groep vervolgens weer een aantal
geassocieerde permissies heeft. 

De \emph{Record} entiteit kan zowel een enkel archiefitem of boek beschrijven,
als een heel archief. Hiervoor is gekozen omdat niet alle archieven
ge\"indexeerd zijn. Ook kan er op deze manier voor een heel archief een
\gls{def:inzage-restrictie} worden opgelegd door gebruik te maken van de
\emph{parent-child} relatie tussen verschillende records.

Er kan een reservering worden aangemaakt voor meerdere \emph{Holding}s
(exemplaren) indien deze nog
niet uitgeleend zijn. Het \emph{special} attribuut in \emph{Reservation} geeft
aan dat het in plaats van een reguliere inzage reservering, een automatische
reproductie reservering betreft (zie ook sectie \ref{subsec:repro_uitgeleend}).

Als er toestemming wordt gevraagd d.m.v. het toestemmingsformulier, wordt er
een \emph{PermissionRequest} aangemaakt, gelinkt aan de bijbehorende stukken
d.m.v. de \emph{RecordPermission} kruistabel. Als de daadwerkelijke
reservering/order wordt geplaatst wordt deze ook nog aan het permissieverzoek
gekoppeld.

Voor een digitaliseringsaanvraag kan een offerte worden gemaakt, welke wordt
opgeslagen in de \emph{Quote} entiteit. Voor een digitale reproductie wordt
een \emph{Order} aangemaakt. Grootafnemers krijgen een klantnummer, wat wordt
bijgehouden in de \emph{Customer} entiteit.


  \begin{figure}[H]
    \label{fig:db2}
    \centering
    \includegraphics[width=\textwidth]{database2.pdf}
    \caption{Database Schema (1 van 2)}
  \end{figure}


  \begin{figure}[H]
    \label{fig:db}
    \centering
    \includegraphics[width=\textwidth]{database.pdf}
    \caption{Database Schema (2 van 2)}
  \end{figure}
  


\chapter{API Specificaties}
\label{cha:api}
In dit hoofdstuk worden zowel de specificaties van de Application Programming
Interface (API) die het systeem aanbiedt, als de externe APIs die het
systeem gebruikt besproken in
respectievelijk sectie \ref{sec:resev}, en sectie \ref{sec:oai_api} en
\ref{sec:sor_api}.

  \section{Delivery API}
  \label{sec:resev}
    Voor de binnenkomende API wordt gebruik gemaakt van een zover mogelijk op
    \gls{def:rest}\footnote{Representational State Transfer (REST)
 \url{http://www.ics.uci.edu/~fielding/pubs/dissertation/rest_arch_style.htm}}
    gebaseerd protocol in combinatie met in \gls{def:json}-ge\"encodeerde
    data\footnote{JavaScript Object Notation \url{http://www.json.org}}. De
    specificaties van alle acties en mogelijke data velden volgen.

    \subsection{Conventies}
      \subsubsection{PIDs}
        Persistant identifiers (\glspl{def:pid}) voor archiefstukken kunnen
        URL-ge\"encodeerd worden
        opgegeven in het formaat ``[PID
        archief].[item nummer]''. Als een PID eindigt met een punt gevolgt
        door een nummer wordt ook aangenomen dat het hier een sub-item
        betreft: het laatste nummer wordt er voor alle externe informatie
        requests afgehaald zodat informatie over het gehele stuk/archief kan
        worden opgevraagd. PIDs voor andere soorten stukken, zoals boeken en
        tijdschriften kunnen worden opgegeven in het formaat ``[PID stuk]''.
      
      \subsubsection{Signaturen}
        Per \emph{Record} (PID) kunnen er meerdere signaturen (\emph{Holding}s) beschikbaar zijn. Denk
        hierbij in het geval van archieven aan orgineel/microfilm, en in het
        geval van tijdschriften en boeken aan verschillende jaargangen/exemplaren. 

        Achter de PID van een bepaald \emph{Record} kan, indien aangegeven, een selectie van
        signaturen worden opgegeven.

      \subsubsection{Output Formaat}
        Het systeem kan voor bepaalde pagina's output geven zowel als een
        JSON-ge\"encodeerde datastructuur als een human-readable HTML pagina.
        Standaard zal het systeem kijken naar de HTTP ``Accept:'' header om te
        bepalen welk formaat te gebruiken (`text/html' of `application/json').
        Voor compatibiliteit is het ook mogelijk om
        ``?format=$\langle$html/json$\rangle$'' als URL parameter te
        specificeren. Het wordt echter aangeraden om de Accept-header te
        gebruiken.

      \subsubsection{Request Methode}
        Het systeem maakt gebruik van zowel DELETE als PUT requests naast de
        normale GET en POST, maar deze methoden worden niet door alle clients
        ondersteund of overcompliceren het mechanisme om requests te
        verzenden. Hiervoor zal het systeem alle URLs die eindigen met
        ``!DELETE'' of ``!PUT'' en POST als request methode gebruiken
        behandelen alsof de methode repectievelijk DELETE danwel PUT is. Voor
        clients, daar waar praktisch, wordt echter aangeraden om de
        daadwerkelijke methodes te specificeren.

      \subsubsection{Authenticatie}
        Elke gebruiker krijgt door het inloggen bij een authenticatie service
        als CAS of LDAP 
        een sessie ID toegewezen. Deze wordt
        in een cookie geset en daardoor met de requests in een header
        meegegeven. Voor geautomatiseerde API calls kan eerst een call om in
        te loggen worden gedaan alvorens calls te doen naar de onderdelen van
        het systeem die authenticatie vereisen.

      \subsubsection{JSONP}\glsadd{def:jsonp}
        Bij elke GET request kan aan de URL een parameter
        ``?callback=$\langle$func$\rangle$'' worden toegevoegd. Voor de output
        zal dan in plaats van simpele JSON een JSONP response met die callback
        worden gegeven.

    \subsection{Formulieren}
      De volgende URLs worden gegarandeerd om naar formulieren voor bepaalde
      acties te leiden.\\

      \begin{tabular}{p{0.4\textwidth} p{0.6\textwidth}}
        \textbf{/reservation/createform/ [pid:signatuur:signatuur:\ldots,
        pid,\ldots]} & Een formulier om een
        aanvraag te doen voor de stukken die horen bij de opgegeven
        pid-signatuur combinaties. Signaturen zijn niet verplicht. Indien geen
        signaturen meegegeven, wordt er arbitrair een exemplaar geselecteerd dat nog
        niet uitgeleend is en tevens een OPEN gebruiksrestrictie heeft. \\
        \textbf{/order/createform/[pid,pid,\ldots]} & Een formulier om een
        bestelling te doen voor reproducties van de stukken die horen bij de
        opgegeven pids. \\
      \end{tabular}

    \pagebreak
    \subsection{Record/Metadata Management}
      Het \emph{Holding} object wordt in verschillende requests en responses
      gebruikt en ziet er als volgt uit:\hfill\\
      \begin{tabular}{l l p{13cm}}
        \textbf{signature} & String & De signatuur van het stuk
        (origineel/microfilm/ZKxx e.d.).\\ 
        \textbf{status} & String & De status van het stuk (`Available',
        `Reserved', `In\_Use', `Returned').\\
        \textbf{usage\_restriction} & String & De gebruiksrestrictie van het
        stuk (`Open', `Closed').\\
        \textbf{floor} & Int & Optioneel: De verdieping waar het stuk staat.\\
        \textbf{direction} & String & Optioneel: De richting waarin het stuk staat op een
        bepaalde verdieping (bijv. Zuid-Oost).\\
        \textbf{cabinet} & Int & Optioneel: De kast waarin het stuk staat.\\
        \textbf{shelf} & Int & Optioneel: Het plank nummer waarop het stuk staat.\\
      \end{tabular}

      \subsubsection{/record/[pid,pid,pid,\ldots]}
        Het element met metadata over een set records.

        \paragraph{GET}\hfill\\
          \namedlabel{api:record:get}{GET /record/[pid,pid,pid,\ldots]}
          Opvraag van de metadata gegevens over een record.

          \subparagraph{Authenticatie}
            Geen authenticatie vereist.

          \subparagraph{Request} N/A

          \subparagraph{Response}
            Gegevens over records in een HTML pagina of JSON.

            De JSON zal een lijst van objects met allen minimaal de volgende
            velden bevatten:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{pid} & String & De PID van het stuk. \\
              \textbf{name} & String & De naam van het stuk. \\
              \textbf{restriction} & String & ``Open'', ``Restricted'' of ``Closed''. \\
              \textbf{holdings} & List$\langle Holding \rangle$ & De
              gespecificeerde holdings
              van dit stuk.\\
            \end{tabular}\hfill\\

            Als de geauthenticeerde gebruiker het recht ``record:contact:view''
            heeft en de restriction niet ``Open'' is wordt de volgende
            informatie ook toegevoegd:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{restriction\_desc} & String & De precieze restrictie op
              het stuk.\\
              \textbf{first\_name} & String & Naam van de contactpersoon voor
              een toestemmingsaanvraag. \\
              \textbf{preposition} & String & ,,\\
              \textbf{last\_name} & String & ,,\\
              \textbf{address} & String & Addres van de contactpersoon.\\
              \textbf{postal\_code} & String & ,,\\
              \textbf{location} & String & ,,\\
              \textbf{country} & String & ,,\\
              \textbf{email} & String & E-Mail van de contactpersoon.\\
              \textbf{phone\_number} & String & Telefoonnummer van de
              contactpersoon.\\
              \textbf{fax} & String & Faxnummer van de contactpersoon.\\
            \end{tabular}

        \paragraph{PUT}\hfill\\
          \namedlabel{api:record:put}{PUT /record/[pid,pid,pid,\ldots]}
          Verander de gegevens van een record of maak nieuwe records aan voor
          stukken.

          \subparagraph{Authenticatie}
            De ingelogde gebruiker moet recht ``record:modify'' hebben.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens.

            Voor alle genoemde PIDs worden deze gegevens in de
            database opgeslagen.

            Als er nog geen record bestaat voor een opgegeven PID wordt deze
            aangemaakt. 

            Als er geen holdings worden meegegeven, wordt er een `Default'
            holding aangemaakt, anders kan er namelijk geen reservering op nog
            niet ge\"indexeerd archief worden gedaan. Als een holding niet
            voorkomt in de opgegeven lijst, maar wel in de database, zal deze worden
            verwijderd. Dit gebeurt alleen als er geen reserveringen aanwezig
            zijn op de desbetreffende holding.

            Het JSON object mag de volgende velden bevatten:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{restriction} & String & ``Open'', ``Restricted'' of ``Closed''. \\
              \textbf{holdings} & List$\langle Holding \rangle$ & De nieuwe
              holdings van dit stuk.\\
            \end{tabular}\hfill\\

            Als de  restriction niet ``Open'' is kunnen de volgende velden
            ook worden ingevuld:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{restriction\_desc} & String & De precieze restrictie op
              het stuk.\\
              \textbf{first\_name} & String & Naam van de contactpersoon voor
              een toestemmingsaanvraag. \\
              \textbf{preposition} & String & ,,\\
              \textbf{last\_name} & String & ,,\\
              \textbf{address} & String & Addres van de contactpersoon.\\
              \textbf{postal\_code} & String & ,,\\
              \textbf{location} & String & ,,\\
              \textbf{country} & String & ,,\\
              \textbf{email} & String & E-Mail van de contactpersoon.\\
              \textbf{phone\_number} & String & Telefoonnummer van de
              contactpersoon.\\
              \textbf{fax} & String & Faxnummer van de contactpersoon.\\
            \end{tabular}

          \subparagraph{Response} N/A

        \paragraph{DELETE}\hfill\\
          \namedlabel{api:record:delete}{DELETE /record/[pid,pid,pid,\ldots]}
          Verwijder de gegevens in de database van alle records met de
          opgegeven PIDs.  Als er reserveringen (of orders) zijn (voor holdings)
          van stukken in de lijst worden de velden van het stuk leeg gemaakt, maar
          wordt het stuk niet daadwerkelijk verwijderd. 

          \subparagraph{Authenticatie}
            De ingelogde gebruiker moet recht ``record:delete'' hebben.

          \subparagraph{Request} N/A
          \subparagraph{Response} N/A

    \pagebreak
    \subsection{Reservering Management}
      \subsubsection{/reservation/}
        De collectie van reserveringen die in het systeem zijn opgeslagen.

        \paragraph{GET}\hfill\\
          \namedlabel{api:reservation-list:get}{GET /reservation/}
          Vraag een lijst met reserveringen in de database op.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``reservation:view''
            hebben.

          \subparagraph{Request}
            De query string kan de volgende parameters bevatten:\\

            \begin{tabular}{l p{13cm}}
              \textbf{page} & Het paginanummer om op te vragen. Default: 1\\
              \textbf{page\_len} & Het aantal records per pagina. Default:
              Implementatieafhankelijk. \\
              \textbf{sort} & Optioneel attribuut om op te sorteren. Ten
              minste mogelijk: ``status'', ``visitor\_email'', ``date'', ``visitor\_name''. \\
              \textbf{sort\_dir} & De volgorde van sorteren: ``asc'' of
              ``desc''. Default: ``asc''.\\
              \textbf{from\_date} & Optioneel: Reserveringen vanaf deze datum
              (yyyy-mm-dd).\\
              \textbf{to\_date} & Optioneel: Reserveringen tot en met deze datum
              (yyyy-mm-dd).\\
              \textbf{search} & Toon alle resultaten waar de meegegeven waarde
              in ```visitor\_name'', ``visitor\_email'' of geassocieerd stuk titel
              voorkomt.\\
              \textbf{\ldots} & Elk String,Boolean of Integer veld kan worden
              gefilterd met een parameter met dezelfde naam.
            \end{tabular}

          \subparagraph{Response}
            Een lijst van de opgevraagde reserveringen in een HTML pagina of
            JSON.

            De JSON zal bestaan uit een lijst van objects met ten minste de
            volgende velden:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de bezoeker. \\
              \textbf{status} & String & ``Pending'', ``Active'' of ``Completed''. \\
              \textbf{date} & String & Gewenste datum: yyyy-mm-dd. \\
              \textbf{special} & Boolean & Of dit een speciale reservering is.
                (Bijvoorbeeld voor de reproductie)\\
              \textbf{items} & Map$\langle$ pid, List$\langle String
                \rangle\rangle$ & Een map van PID naar een lijst van signaturen
                die zijn aangevraagd (deze lijst bestaat altijd uit minimaal 1
                signatuur).\\
            \end{tabular}

        \paragraph{POST}\hfill\\
          \namedlabel{api:reservation-list:post}{POST /reservation/}
          Maak een nieuwe reservering aan.

          \subparagraph{Authenticatie}
            Geen authenticatie vereist.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens.

            Er wordt een nieuwe reservering aangemaakt met de opgegeven data.

            Tenminste de volgende informatie moet worden meegegeven:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de
               bezoeker. \\
              \textbf{date} & String & Gewenste datum: yyyy-mm-dd. \\
              \textbf{items} & Map$\langle$ pid, List$\langle String
                \rangle\rangle$ & Een map van PID naar een lijst van signaturen
                die worden aangevraagd. De lijst van signaturen kan ook leeg
                zijn. In dat geval wordt de eerst gevonden holding gereserveerd die nog niet
                uitgeleend is en die tevens gebruiksrestrictie OPEN heeft. \\
            \end{tabular}\hfill\\

          \subparagraph{Response}
            Bij een succesvolle operatie wordt een 303 redirect teruggegeven.

            De redirect zal leiden naar de nieuwe reservering.


      \pagebreak
      \subsubsection{/reservation/[id]}
      Een enkele reservering.

        \paragraph{GET}\hfill\\
          \namedlabel{api:reservation:get}{GET /reservation/[id]}
          Vraag informatie over de inhoud van deze reservering.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``reservation:view''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response}
            Informatie over de reservering in HTML of JSON formaat.

            Ten minste de volgende velden zullen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de bezoeker. \\
              \textbf{status} & String & ``Pending'', ``Active'' of ``Completed''. \\
              \textbf{date} & String & Gewenste datum: yyyy-mm-dd. \\
              \textbf{special} & Boolean & Of dit een speciale reservering is.
                (Bijvoorbeeld voor de reproductie)\\
              \textbf{items} & Map$\langle$ pid, List$\langle String
                \rangle\rangle$ & Een map van PID naar een lijst van signaturen
                die zijn aangevraagd (deze lijst bestaat altijd uit minimaal 1
                signatuur).\\
            \end{tabular}

        \paragraph{PUT}\hfill\\
          \namedlabel{api:reservation:put}{PUT /reservation/[id]}
          Verander de gegevens van een reservering.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``reservation:modify''
            hebben.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens;

            De gegevens van de gespecificeerde reservering worden aangepast
            naar de nieuwe gegevens.

            De volgende velden kunnen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de bezoeker. \\
              \textbf{status} & String & ``Pending'', ``Active'' of ``Completed''. \\
              \textbf{date} & String & Gewenste datum: yyyy-mm-dd. \\
            \end{tabular}

          \subparagraph{Response} N/A

          \subparagraph{Postconditie} Als de status van een reservering is
          veranderd is ook automatisch de status van de betreffende stukken
          aangepast.

        \paragraph{DELETE}\hfill\\
          \namedlabel{api:reservation:delete}{DELETE /reservation/[id]}
          Verwijder een reservering.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``reservation:delete''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response} N/A

          \subparagraph{Postconditie} Als het een actieve reservering betreft
          is de status van de in de reservering opgenomen stukken veranderd
          naar beschikbaar.

    \pagebreak
    \subsection{Order Management}
      \subsubsection{/order/}
        De collectie van orders voor reproducties die in het systeem zijn opgeslagen.

        \paragraph{GET}\hfill\\
          \namedlabel{api:order-list:get}{GET /order/}
          Vraag een lijst met orders in de database op.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``order:view''
            hebben.

          \subparagraph{Request}
            De query string kan de volgende parameters bevatten:\\

            \begin{tabular}{l p{13cm}}
              \textbf{page} & Het paginanummer om op te vragen. Default: 1\\
              \textbf{page\_len} & Het aantal records per pagina. Default:
              Implementatieafhankelijk. \\
              \textbf{sort} & Optioneel attribuut om op te sorteren. Ten
              minste mogelijk: ``status'' en ``visitor\_name''. \\
              \textbf{sort\_dir} & De volgorde van sorteren: ``asc'' of
              ``desc''. Default: ``asc''.\\
              \textbf{\ldots} & Elk String,Boolean of Integer veld kan worden
                gefilterd met een parameter met dezelfde naam.
            \end{tabular}

          \subparagraph{Response}
            Een lijst van de opgevraagde reserveringen in een HTML pagina of JSON.

            De JSON zal bestaan uit een lijst van objects met ten minste de
            volgende velden:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{customer\_name} & String & De naam van de klant. \\
              \textbf{customer\_email} & String & Het e-mail adres van de
              klant. \\
              \textbf{status} & String & ``Pending'' of ``Completed''. \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$ & De lijst van
              $\langle$pid, filetype$\rangle$ pairs waarvan reproducties zijn aangevraagd.\\
            \end{tabular}

        \paragraph{POST}\hfill\\
          \namedlabel{api:order-list:post}{POST /order/}
          Maak een nieuwe order aan.

          \subparagraph{Authenticatie}
            Geen authenticatie vereist.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens.

            Er wordt een nieuwe order aangemaakt met de opgegeven data.

            Tenminste de volgende informatie moet worden meegegeven:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{customer\_name} & String & De naam van de klant. \\
              \textbf{customer\_email} & String & Het e-mail adres van de
              klant. \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$ & De lijst van
              $\langle$pid, filetype$\rangle$ pairs waarvan reproducties
              zijn aangevraagd.\\
            \end{tabular}\hfill\\

          \subparagraph{Response}
            Bij een succesvolle operatie wordt een 303 redirect teruggegeven.

            De redirect zal leiden naar de nieuwe order.

      \pagebreak
      \subsubsection{/order/[id]}
      Een enkele order.

        \paragraph{GET}\hfill\\
          \namedlabel{api:order:get}{GET /order/[id]}
          Vraag informatie over de inhoud van deze order.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``order:view''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response}
            Informatie over de order in HTML of JSON formaat.

            Ten minste de volgende velden zullen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{customer\_name} & String & De naam van de klant. \\
              \textbf{customer\_email} & String & Het e-mail adres van de
              klant. \\
              \textbf{status} & String & ``Pending'' of ``Completed''. \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$ & De lijst van
              $\langle$pid, filetype$\rangle$ pairs waarvan reproducties zijn aangevraagd.\\
            \end{tabular}

        \paragraph{PUT}\hfill\\
          \namedlabel{api:order:put}{PUT /order/[id]}
          Verander de gegevens van een order.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``order:modify''
            hebben.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens;

            De gegevens van de gespecificeerde order worden aangepast
            naar de nieuwe gegevens.

            De volgende velden kunnen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{customer\_name} & String & De naam van de klant. \\
              \textbf{customer\_email} & String & Het e-mail adres van de
              klant. \\
              \textbf{status} & String & ``Pending'' of ``Completed''. \\
            \end{tabular}

          \subparagraph{Response} N/A

        \paragraph{DELETE}\hfill\\
          \namedlabel{api:order:delete}{DELETE /order/[id]}
          Verwijder een order.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``order:delete''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response} N/A

    \pagebreak
    \subsection{Permission Management}
      \subsubsection{/permission/}
        De collectie van verzoeken voor toestemming voor inzage.

        \paragraph{GET}\hfill\\
          \namedlabel{api:permission-list:get}{GET /permission/}
          Vraag een lijst met verzoeken in de database op.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``permission:view''
            hebben.

          \subparagraph{Request}
            De query string kan de volgende parameters bevatten:\\

            \begin{tabular}{l p{13cm}}
              \textbf{page} & Het paginanummer om op te vragen. Default: 1\\
              \textbf{page\_len} & Het aantal records per pagina. Default:
              Implementatieafhankelijk. \\
              \textbf{sort} & Optioneel attribuut om op te sorteren. Ten
              minste mogelijk: ``visitor\_name'', ``visitor\_email'',
              ``status'', ``from\_date'', ``to\_date'',
              ``research\_organization'', ``research\_subject''. \\
              \textbf{sort\_dir} & De volgorde van sorteren: ``asc'' of
              ``desc''. Default: ``asc''.\\
              \textbf{search} & Zoek in alle velden behalve ``status''.\\
              \textbf{\ldots} & Elk String,Boolean of Integer veld kan worden
                gefilterd met een parameter met dezelfde naam.
            \end{tabular}

          \subparagraph{Response}
            Een lijst van de opgevraagde verzoeken in een HTML pagina of JSON.

            De JSON zal bestaan uit een lijst van objects met ten minste de
            volgende velden:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de
              bezoeker. \\
              \textbf{address} & String & Volledig post adres van de bezoeker.
              \\
              \textbf{status} & String & ``Pending'' of ``HANDLED''. \\
              \textbf{from\_date} & String & Start datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{to\_date} & String & Eind datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{research\_organization} & String & Opdrachtgever van
              onderzoek waarvoor toegang nodig is tot stukken met restricties.
              \\
              \textbf{research\_subject} & String & Onderwerp van onderzoek. \\
              \textbf{explanation} & String & Onderbouwing toestemmingsaanvraag.
              \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$
              & De $\langle$pid, status, [motivation]$\rangle$ tupels van de stukken waarvoor
              toestemming is verzocht. De motivatie wordt weggelaten indien niet
              gespecificeerd.\\
            \end{tabular}

        \paragraph{POST}\hfill\\
          \namedlabel{api:permission-list:post}{POST /permission/}
          Maak een nieuw verzoek aan.

          \subparagraph{Authenticatie}
            Geen authenticatie vereist.

          \subparagraph{Request}
            De request is een enkel JSON of form object met gegevens.

            Er wordt een nieuw verzoek met de opgegeven data.

            Tenminste de volgende informatie moet worden meegegeven:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de
              bezoeker. \\
              \textbf{address} & String & Volledig post adres van de bezoeker.
              \\
              \textbf{status} & String & ``Pending'' of ``HANDLED''. \\
              \textbf{from\_date} & String & Start datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{to\_date} & String & Eind datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{research\_organization} & String & Opdrachtgever van
              onderzoek waarvoor toegang nodig is tot stukken met restricties.
              \\
              \textbf{research\_subject} & String & Onderwerp van onderzoek. \\
              \textbf{explanation} & String & Onderbouwing toestemmingsaanvraag.
              \\
              \textbf{items} & List$\langle$String$\rangle$
              & De PIDs van de stukken waarvoor toestemming wordt verzocht.\\
            \end{tabular}\hfill\\

          \subparagraph{Response}
            Bij een succesvolle operatie wordt een 303 redirect teruggegeven.

            De redirect zal leiden naar het nieuwe verzoek.

      \pagebreak
      \subsubsection{/permission/[id]}
      Een enkel verzoek.

        \paragraph{GET}\hfill\\
          \namedlabel{api:permission:get}{GET /permission/[id]}
          Vraag informatie over de inhoud van dit verzoek.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``permission:view''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response}
            Informatie over het verzoek in HTML of JSON formaat.

            Ten minste de volgende velden zullen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{8cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de
              bezoeker. \\
              \textbf{address} & String & Volledig post adres van de bezoeker.
              \\
              \textbf{status} & String & ``Pending'' of ``HANDLED''. \\
              \textbf{from\_date} & String & Start datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{to\_date} & String & Eind datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{research\_organization} & String & Opdrachtgever van
              onderzoek waarvoor toegang nodig is tot stukken met restricties.
              \\
              \textbf{research\_subject} & String & Onderwerp van onderzoek. \\
              \textbf{explanation} & String & Onderbouwing toestemmingsaanvraag.
              \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$
              & De $\langle$pid, status, [motivation]$\rangle$ tupels van de stukken waarvoor
              toestemming is verzocht. De motivatie wordt weggelaten indien niet
              gespecificeerd.\\

            \end{tabular}

        \paragraph{PUT}\hfill\\
          \namedlabel{api:permission:put}{PUT /permission/[id]}
          Verander de gegevens van een verzoek.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``permission:modify''
            hebben.

          \subparagraph{Request}
            De request is een enkel JSON object met gegevens;

            De gegevens van het gespecificeerde verzoek worden aangepast
            naar de nieuwe gegevens.

            De volgende velden kunnen in de JSON aanwezig zijn:\\

            \begin{tabular}{ l l p{10cm} }
              \textbf{visitor\_name} & String & De naam van de bezoeker. \\
              \textbf{visitor\_email} & String & Het e-mail adres van de
              bezoeker. \\
              \textbf{address} & String & Volledig post adres van de bezoeker.
              \\
              \textbf{status} & String & ``Pending'' of ``HANDLED''. \\
              \textbf{from\_date} & String & Start datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{to\_date} & String & Eind datum van de toestemming,
              formaat: yyyy-MM-dd. \\
              \textbf{research\_organization} & String & Opdrachtgever van
              onderzoek waarvoor toegang nodig is tot stukken met restricties.
              \\
              \textbf{research\_subject} & String & Onderwerp van onderzoek. \\
              \textbf{explanation} & String & Onderbouwing toestemmingsaanvraag.
              \\
              \textbf{items} & List$\langle$List$\langle$String$\rangle\rangle$
              & De $\langle$pid, status$\rangle$ paren van de stukken waarvoor
              toestemming wordt verzocht.\\
            \end{tabular}

          \subparagraph{Response} N/A

        \paragraph{DELETE}\hfill\\
          \namedlabel{api:permission:delete}{DELETE /permission/[id]}
          Verwijder een verzoek.

          \subparagraph{Authenticatie}
            De geauthenticeerde gebruiker moet het recht ``permission:delete''
            hebben.

          \subparagraph{Request} N/A

          \subparagraph{Response} N/A

  \pagebreak
  \section{Externe Informatie API}
  \label{sec:oai_api}

  Voor het ophalen van informatie over de opgevraagde stukken worden de PIDs
  (na afstrippen van de itemnummers) doorgegeven naar de externe API
  abstractielaag. Deze laag zal API calls maken naar de service waar de
  informatie over de stukken in opgeslagen staat.

  APIs voor informatie moeten ten minste een call ondersteunen met de PID als
  input en outputvelden voor de naam en description van een stuk. Meer
  informatie is niet vereist.

  Bij het IISG zal gebruik worden gemaakt van de bestaande OAI-PMH interface
  waarvanuit informatie over alle stukken te benaderen is.

  \section{Externe Reproductie API}
  \label{sec:sor_api}

  Voor het downloaden van gedigitalizeerde stukken en het opvragen van de
  mogelijke filetypes worden de PIDs van aangevraagde reproducties doorgegeven
  naar een andere externe API abstractielaag. Deze laag maakt API calls naar
  repositories met digitale reproducties van stukken.

  De API moet ondersteuning bieden voor het aanmaken van credentials of een
  access key waarmee bestanden kunnen worden gedownload. Ook moet de API
  kunnen aangeven of er digitale reproducties beschikbaar zijn, en welke
  bestandstypen mogen worden besteld.

  Bij het IISG zal gebruik worden gemaakt van de Shared Object Repository
  waar reproducties van alle gedigitalizeerde stukken in zijn opgenomen.

\printglossary[title=Verklarende Woordenlijst,toctitle=Verklarende Woordenlijst]
\end{document}
